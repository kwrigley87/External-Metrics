<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>External Metrics CSV Uploader (no SDK)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">External Metrics CSV Uploader</h1>

    <!-- Auth config (mirrors your External Interactions app) -->
    <script>
      // === Configure these for your org/repo ===
      const CLIENT_ID    = '8e243c51-4a4f-49e9-9f7e-2c8333f02a06'; // safe to expose
      const REDIRECT_URI = 'https://kwrigley87.github.io/External-Metrics/'; // EXACT match in OAuth client
      const DEFAULT_REGION = 'usw2.pure.cloud';
      // If your org enforces scopes, include what you need. Otherwise, it won’t block.
      // Add others if required in your org (e.g., 'users:readonly'). External Metrics is part of Performance/Gamification.
      const SCOPES = ['users:readonly', 'conversations', 'routing:readonly', 'quality'].join(' ');
      // ==========================================
    </script>

    <!-- Region -->
    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-1">Region</label>
        <select id="region" class="w-full border rounded p-2">
          <option value="mypurecloud.com">US East (mypurecloud.com)</option>
          <option value="usw2.pure.cloud">US West 2 (usw2.pure.cloud)</option>
          <option value="cac1.pure.cloud">Canada (cac1.pure.cloud)</option>
          <option value="mypurecloud.ie">EU West (Ireland)</option>
          <option value="euw2.pure.cloud">EU West 2 (London)</option>
          <option value="mypurecloud.de">Germany</option>
          <option value="apne2.pure.cloud">Tokyo</option>
          <option value="apne1.pure.cloud">Seoul</option>
          <option value="mypurecloud.com.au">Sydney</option>
          <option value="sae1.pure.cloud">São Paulo</option>
        </select>
      </div>
      <div class="flex items-end">
        <button id="btnLogin" type="button" class="px-4 py-2 rounded bg-black text-white mr-2">Sign in</button>
        <button id="btnLogout" type="button" class="px-4 py-2 rounded bg-gray-200">Sign out</button>
        <div class="ml-auto text-sm text-gray-700"><span id="whoami"></span></div>
      </div>
    </div>

    <!-- CSV -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">CSV file</label>
      <input id="csvFile" type="file" accept=".csv" class="block w-full text-sm" />
      <p class="text-xs text-gray-500 mt-1">
        Header: <code>metricId,userId,email,value,type,dateOccurred</code>. Provide <em>userId</em> OR <em>email</em> (not both).
        <strong>type</strong>: <code>total</code> (default) or <code>cumulative</code>. Date as <code>YYYY-MM-DD</code>.
      </p>
    </div>

    <!-- Controls -->
    <div class="grid md:grid-cols-4 gap-4 mb-3">
      <div>
        <label class="block text-sm font-medium mb-1">Max concurrency (1–5)</label>
        <input id="concurrency" type="number" min="1" max="5" value="3" class="w-full border rounded p-2" />
      </div>
      <div class="md:col-span-3 flex items-end gap-2">
        <button id="btnValidate" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Validate CSV</button>
        <button id="btnUpload"   type="button" class="px-4 py-2 rounded bg-green-600 text-white" disabled>Upload to Genesys</button>
        <button id="btnCancel"   type="button" class="px-4 py-2 rounded bg-gray-200" disabled>Cancel</button>
      </div>
    </div>

    <!-- Progress -->
    <div class="mb-2">
      <div class="text-sm font-medium">Progress</div>
      <div class="w-full bg-gray-200 rounded h-3">
        <div id="bar" class="bg-green-500 h-3 rounded" style="width:0%"></div>
      </div>
      <div id="stats" class="text-xs text-gray-600 mt-1">Waiting…</div>
    </div>

    <!-- Log -->
    <details class="mt-3" open>
      <summary class="cursor-pointer font-medium">Log</summary>
      <pre id="log" class="mt-2 p-3 bg-white border rounded overflow-auto text-xs h-64"></pre>
    </details>
  </div>

<script>
(function init() {
  // === UI refs
  const regionEl = document.getElementById('region');
  const whoamiEl = document.getElementById('whoami');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnValidate = document.getElementById('btnValidate');
  const btnUpload = document.getElementById('btnUpload');
  const btnCancel = document.getElementById('btnCancel');

  // === State
  let token = null;
  let parsedRows = [];
  let cancelRequested = false;

  // === Helpers
  function log(msg) {
    const el = document.getElementById('log');
    const ts = new Date().toISOString();
    el.textContent += `[${ts}] ${msg}\n`;
    el.scrollTop = el.scrollHeight;
  }
  function setProgress(done, total, ok, failed) {
    const pct = total ? Math.round((done/total)*100) : 0;
    document.getElementById('bar').style.width = pct + '%';
    document.getElementById('stats').textContent = `Batches: ${done}/${total} • OK: ${ok} • Failed: ${failed}`;
  }
  function getTokenFromHash() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    return params.get('access_token');
  }
  function clearHashAndReload() {
    history.replaceState({}, document.title, location.pathname + location.search);
    location.reload();
  }

  // === Auth like your External Interactions app
  function buildAuthUrl() {
    const region = regionEl.value || DEFAULT_REGION;
    const url = new URL(`https://login.${region}/oauth/authorize`);
    url.searchParams.set('client_id', CLIENT_ID);
    url.searchParams.set('response_type', 'token');
    url.searchParams.set('redirect_uri', REDIRECT_URI);
    url.searchParams.set('scope', SCOPES);
    return url.toString();
  }

  async function whoAmI() {
    // lightweight “me” call to confirm token works
    const region = regionEl.value || DEFAULT_REGION;
    const res = await fetch(`https://api.${region}/api/v2/users/me`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error(`users/me failed ${res.status}`);
    return res.json();
  }

  // === Wire buttons
  btnLogin.addEventListener('click', () => {
    localStorage.setItem('extm_region', regionEl.value);
    window.location.href = buildAuthUrl();
  });
  btnLogout.addEventListener('click', () => clearHashAndReload());

  btnValidate.addEventListener('click', async () => {
    const file = document.getElementById('csvFile').files?.[0];
    if (!file) return alert('Choose a CSV file first.');
    try {
      parsedRows = await parseCsv(file);
      const issues = validateRows(parsedRows);
      if (issues.length) {
        log('Validation issues:\n' + issues.join('\n'));
        alert(`Found ${issues.length} validation issue(s). See log.`);
        btnUpload.disabled = false; // flip to true to block on validation errors
      } else {
        log(`Validation OK. ${parsedRows.length} row(s) ready.`);
        btnUpload.disabled = false;
      }
    } catch (e) {
      log('CSV parse failed → ' + (e.message || e));
      alert('CSV parse failed (see log).');
    }
  });

  btnUpload.addEventListener('click', uploadAll);
  btnCancel.addEventListener('click', () => { cancelRequested = true; });

  // === CSV
  function parseCsv(file) {
    log(`Parsing: ${file.name} (${Math.round(file.size/1024)} KB)`);
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        transformHeader: h => h.trim(),
        transform: v => typeof v === 'string' ? v.trim() : v,
        complete: r => resolve(r.data || []),
        error: err => reject(err)
      });
    });
  }
  function validateRows(rows) {
    const errs = [];
    rows.forEach((r, i) => {
      const row = i + 2;
      if (!r.metricId) errs.push(`Row ${row}: metricId required (External ID from External Metric Definitions)`);
      if (!r.userId && !r.email) errs.push(`Row ${row}: either userId or email is required`);
      if (r.userId && r.email) errs.push(`Row ${row}: provide userId OR email, not both`);
      if (r.value === undefined || r.value === '') errs.push(`Row ${row}: value is required`);
      if (r.value && isNaN(Number(r.value))) errs.push(`Row ${row}: value must be numeric`);
      if (r.type && !['total','cumulative'].includes(String(r.type).toLowerCase()))
        errs.push(`Row ${row}: type must be total|cumulative`);
      if (!r.dateOccurred || !/^\d{4}-\d{2}-\d{2}$/.test(r.dateOccurred))
        errs.push(`Row ${row}: dateOccurred must be YYYY-MM-DD`);
    });
    return errs;
  }

  // === Upload (100 per request, parallel workers)
  async function uploadAll() {
    if (!token) return alert('Please sign in first.');
    if (!parsedRows.length) return alert('Validate your CSV first.');

    cancelRequested = false;
    btnCancel.disabled = false;

    const items = parsedRows.map(r => ({
      metricId: r.metricId,
      value: Number(r.value),
      type: (r.type || 'total').toLowerCase(),
      dateOccurred: r.dateOccurred,
      userId: r.userId || undefined,
      email: r.email || undefined
    }));

    // chunk into 100 as requested
    const chunks = [];
    for (let i = 0; i < items.length; i += 100) chunks.push(items.slice(i, i + 100));

    const maxConcurrency = Math.min(Number(document.getElementById('concurrency').value || 3), 5);
    let done = 0, ok = 0, failed = 0;
    setProgress(0, chunks.length, 0, 0);
    log(`Starting upload: ${items.length} rows in ${chunks.length} batch(es), concurrency=${maxConcurrency}`);

    const queue = chunks.map((payload, idx) => ({ idx: idx + 1, payload }));
    const workers = Array.from({ length: maxConcurrency }, () => worker());

    async function worker() {
      const region = regionEl.value || DEFAULT_REGION;
      while (queue.length && !cancelRequested) {
        const job = queue.shift();
        if (!job) break;
        try {
          await postChunk(region, job.idx, job.payload);
          ok++; log(`Batch ${job.idx}: OK (${job.payload.length} items)`);
        } catch (e) {
          failed++; log(`Batch ${job.idx}: FAILED → ${e.message || e}`);
        } finally {
          done++; setProgress(done, chunks.length, ok, failed);
        }
      }
    }

    await Promise.all(workers);
    btnCancel.disabled = true;

    if (cancelRequested) { log('Upload cancelled.'); alert('Upload cancelled.'); }
    else if (failed === 0) { log('All batches uploaded successfully ✅'); alert('Upload complete!'); }
    else { log('Upload completed with failures. See log.'); alert(`Upload finished. ${failed} batch(es) failed.`); }
  }

  async function postChunk(region, batchNumber, items) {
    const url = `https://api.${region}/api/v2/employeeperformance/externalmetrics/data`;
    const body = JSON.stringify({ items });

    let attempt = 0, maxAttempts = 5;
    while (true) {
      attempt++;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body
      });

      if (res.ok) return;

      if ((res.status === 429 || res.status >= 500) && attempt < maxAttempts) {
        const retryAfter = Number(res.headers.get('Retry-After')) || 0;
        const backoff = retryAfter ? retryAfter * 1000 : Math.min(30000, 1000 * Math.pow(2, attempt));
        log(`Batch ${batchNumber}: attempt ${attempt} → ${res.status}. Retrying in ${Math.round(backoff/1000)}s…`);
        await new Promise(r => setTimeout(r, backoff));
        continue;
      }

      let msg = `${res.status} ${res.statusText}`;
      try { const t = await res.text(); if (t) msg += ` | ${t.substring(0, 500)}`; } catch {}
      throw new Error(msg);
    }
  }

  // === Boot
  // restore region and token
  regionEl.value = localStorage.getItem('extm_region') || DEFAULT_REGION;
  token = getTokenFromHash();
  if (token) {
    // show welcome text (optional, lightweight check)
    whoAmI().then(me => {
      whoamiEl.textContent = `Welcome, ${me.name}`;
      log(`Signed in as ${me.name}`);
    }).catch(() => {
      whoamiEl.textContent = 'Signed in';
      log('Signed in (users/me check failed, continuing)');
    });
  } else {
    log('Not signed in. Click "Sign in" to authenticate.');
  }
})();
</script>
</body>
</html>
